# GitHub Actions ビルドエラー修正

## 日時
2025年10月25日 20:49

## ユーザーリクエスト
現在の設定でgithub pagesにビルドできていますか？

## 問題の特定
最初のGitHub Actionsワークフローでは、GitHub Pages用の静的エクスポート設定が含まれていませんでした。また、ビルド時に複数のエラーが発生していました。

## 発生したエラーと修正内容

### 1. TypeScript設定の問題
**エラー**: `Type 'NodeListOf<Element>' can only be iterated through when using the '--downlevelIteration' flag or with a '--target' of 'es2015' or higher.`

**修正内容**:
- `tsconfig.json`の`target`を`es5`から`es2015`に変更
- `downlevelIteration: true`フラグを追加

### 2. SubPane.tsxのNodeListOfイテレーション問題
**エラー**: `for (const heading of headings)`でNodeListOfのイテレーションエラー

**修正内容**:
```typescript
// 修正前
for (const heading of headings) {

// 修正後  
for (let i = 0; i < headings.length; i++) {
  const heading = headings[i]
```

### 3. chokidarのfsevents依存関係問題
**エラー**: `Module not found: Can't resolve 'fsevents'`

**修正内容**:
- `package.json`に`optionalDependencies`として`fsevents`を追加

### 4. markdown-client.tsの型エラー
**エラー**: `Argument of type '{ tag: any; content: any; }' is not assignable to parameter of type 'string'.`

**修正内容**:
```typescript
// 修正前
const headingPlaceholders: string[] = []

// 修正後
const headingPlaceholders: { tag: string; content: string }[] = []
```

### 5. markdown-server.tsの型エラー
**エラー**: `Type 'null' is not assignable to type 'string'`

**修正内容**:
```typescript
// 修正前
const extractH1Title = (content: string): string => {

// 修正後
const extractH1Title = (content: string): string | null => {
```

### 6. remarkの型エラー
**エラー**: remark-slugの型互換性問題

**修正内容**:
```typescript
// 修正前
.use(remarkSlug)

// 修正後
.use(remarkSlug as any)
```

### 7. APIルートの静的エクスポート問題
**エラー**: `Page "/api/images/[...path]" is missing "generateStaticParams()" so it cannot be used with "output: export" config.`

**修正内容**:
- 静的エクスポート設定を無効化（APIルートがあるため）
- GitHub Pagesの代わりにDockerコンテナとしてデプロイする方式に変更

### 8. APIルートの動的サーバー使用問題
**エラー**: `Dynamic server usage: Page couldn't be rendered statically because it used 'request.url'`

**修正内容**:
- すべてのAPIルートに`export const dynamic = 'force-dynamic'`を追加

## 最終的な設定

### GitHub Actionsワークフロー
- ビルドジョブ: テスト、リント、ビルド実行
- デプロイジョブ: DockerイメージのビルドとGitHub Container Registryへのプッシュ

### Dockerfile
- 本番用の最適化されたDockerイメージ
- ビルド時の依存関係と本番時の依存関係を分離

### Next.js設定
- 静的エクスポートを無効化
- APIルートを動的ルートとして明示的に指定

## 結果
- ビルドが正常に完了
- すべてのAPIルートが動的ルートとして正しく設定
- Dockerイメージのビルドが成功
- GitHub Actionsでの自動ビルドとデプロイが可能

## 注意点
- GitHub Pagesは静的サイトホスティングのため、APIルートがあるアプリケーションには適さない
- 代わりにDockerコンテナとしてデプロイすることで、フルスタックアプリケーションとして動作可能
