# チャットログ - 2025年09月23日 19:51

## 概要
Next.jsアプリケーションを静的サイトとしてビルドして動作させるための設定を行いました。

## ユーザーの要求
- 一度きり、このアプリをビルドして静的に動作させる
- ホストPCに余計なインストールはしたくない
- ビルド実行もコンテナから行う

## 実装内容

### 1. Next.js設定の更新
- `next.config.js`に`output: 'export'`を追加
- `trailingSlash: true`と`images: { unoptimized: true }`を設定
- 静的エクスポート用の設定を追加

### 2. Dockerfileの更新
- マルチステージビルドに変更
- ビルドステージ: Node.js 18 Alpine
- 本番ステージ: nginx Alpine
- 静的ファイルをnginxで配信

### 3. docker-compose.ymlの更新
- `wiki-static`サービスを追加
- ポート8080で静的サイトを配信

### 4. 静的データ生成スクリプトの作成
- `scripts/generate-static-data.js`を作成
- プロジェクトのMarkdownファイルを静的JSONファイルに変換
- 各プロジェクトごとに`{project}-docs.json`と`{project}-terms.json`を生成

### 5. APIルートの削除とフロントエンドの修正
- APIルートディレクトリを削除
- フロントエンドのコードを静的データファイルを使用するように修正
  - `useMarkdownData.ts`: APIルートの代わりに静的JSONファイルを取得
  - `useProjects.ts`: `/api/projects.json`を使用
  - `ContentPane.tsx`: 静的データから特定のドキュメントを検索
  - `SubPane.tsx`: 同様に静的データを使用
  - `useFileWatcher.ts`: 静的生成時は無効化

### 6. 型エラーの修正
- `markdown-client.ts`: 型定義に`frontmatter`プロパティを追加
- `markdown-server.ts`: remarkプラグインの型エラーを修正（`as any`でキャスト）

### 7. package.jsonの更新
- `build:static`スクリプトを追加
- 静的データ生成とビルドを組み合わせたスクリプト

## 技術的な課題と解決策

### 課題1: TypeScriptの型エラー
- `markdown-client.ts`で`string | boolean`型エラーが発生
- 解決策: 条件分岐を明示的に`boolean`型にキャスト

### 課題2: remarkプラグインの型エラー
- remarkプラグインの型定義が競合
- 解決策: `as any`でキャストして型チェックを回避

### 課題3: 静的生成時のAPIルート問題
- `request.url`が静的生成時に利用できない
- 解決策: APIルートを削除して静的データファイルを使用

### 課題4: `/api/watch`エンドポイントのタイムアウト
- Server-Sent Eventsエンドポイントが静的生成を妨げる
- 解決策: APIルートを完全に削除

## 最終結果
- 静的サイトのビルドが成功
- nginxでポート8080で配信
- HTTP 200レスポンスで正常に動作確認

## 使用方法
```bash
# 静的サイトのビルドと起動
docker compose build wiki-static
docker compose up wiki-static

# アクセス
http://localhost:8080
```

## 注意事項
- 開発時のリアルタイムファイル監視機能は静的生成時には無効
- APIルートは削除されているため、動的な機能は利用不可
- 静的データはビルド時に生成されるため、コンテンツ更新時は再ビルドが必要
