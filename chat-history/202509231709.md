# チャットログ - 2025年09月23日 17:09

## ユーザーリクエスト
Unhandled Runtime Error
Error: Hydration failed because the initial UI does not match what was rendered on the server.

Warning: Expected server HTML to contain a matching <div> in <div>.

See more info here: https://nextjs.org/docs/messages/react-hydration-error

## 問題の詳細

### Hydrationエラーの原因
- サーバーサイドレンダリング（SSR）とクライアントサイドレンダリング（CSR）で異なるHTMLが生成される
- `localStorage`を使用してプロジェクト選択を初期化しているため、サーバーサイドでは`localStorage`にアクセスできない
- サーバーサイドでは空文字列、クライアントサイドではlocalStorageの値が設定される

### エラーの詳細
```
Error: Hydration failed because the initial UI does not match what was rendered on the server.
Warning: Expected server HTML to contain a matching <div> in <div>.
```

## 実装内容

### SSR/CSRの一貫性を保つための修正

#### 1. 初期化の修正
**ファイル**: `app/page.tsx`

```typescript
export default function Home() {
  const [selectedProject, setSelectedProject] = useState<string>('')
  const [selectedDoc, setSelectedDoc] = useState<string | null>(null)
  const [selectedTerm, setSelectedTerm] = useState<string | null>(null)
  const [subPaneTab, setSubPaneTab] = useState<'toc' | 'preview'>('toc')
  const [isClient, setIsClient] = useState(false)
  
  const { projects, loading: projectsLoading } = useProjects()
  const { docs, terms, loading } = useMarkdownData(selectedProject)

  // クライアントサイドでのみlocalStorageからプロジェクト選択を読み込み
  useEffect(() => {
    setIsClient(true)
    const lastProject = localStorage.getItem('last-selected-project')
    if (lastProject) {
      setSelectedProject(lastProject)
    }
  }, [])
```

#### 2. プロジェクト存在確認の修正
**ファイル**: `app/page.tsx`

```typescript
// プロジェクト一覧が読み込まれた後、保存されたプロジェクトが存在しない場合は選択をクリア
useEffect(() => {
  if (isClient && !projectsLoading && projects.length > 0 && selectedProject) {
    const projectExists = projects.some(project => project.name === selectedProject)
    if (!projectExists) {
      console.log('Saved project not found, clearing selection:', selectedProject)
      setSelectedProject('')
      localStorage.removeItem('last-selected-project')
    }
  }
}, [isClient, projects, projectsLoading, selectedProject])
```

#### 3. プロジェクト選択ハンドラーの修正
**ファイル**: `app/page.tsx`

```typescript
const handleProjectSelect = (projectName: string) => {
  setSelectedProject(projectName)
  setSelectedDoc(null) // プロジェクト変更時は選択をクリア
  setSelectedTerm(null)
  setSubPaneTab('toc')
  
  // 選択したプロジェクトをlocalStorageに保存
  if (isClient) {
    localStorage.setItem('last-selected-project', projectName)
  }
}
```

## 技術的詳細

### 修正前の問題
```typescript
// 問題のあるコード
const [selectedProject, setSelectedProject] = useState<string>(() => {
  if (typeof window !== 'undefined') {
    const lastProject = localStorage.getItem('last-selected-project')
    return lastProject || ''
  }
  return ''
})
```

**問題点**:
- サーバーサイドでは`typeof window !== 'undefined'`が`false`になり空文字列
- クライアントサイドでは`localStorage`の値が設定される
- SSRとCSRで異なる初期値が設定される

### 修正後の解決策
```typescript
// 修正されたコード
const [selectedProject, setSelectedProject] = useState<string>('')
const [isClient, setIsClient] = useState(false)

useEffect(() => {
  setIsClient(true)
  const lastProject = localStorage.getItem('last-selected-project')
  if (lastProject) {
    setSelectedProject(lastProject)
  }
}, [])
```

**解決点**:
- サーバーサイドとクライアントサイドで同じ初期値（空文字列）
- `useEffect`でクライアントサイドでのみlocalStorageを読み込み
- `isClient`フラグでクライアントサイドかどうかを管理

### 動作フロー

#### サーバーサイドレンダリング
1. `selectedProject`が空文字列で初期化
2. `isClient`が`false`で初期化
3. プロジェクト選択画面が表示される

#### クライアントサイドハイドレーション
1. サーバーと同じ状態で開始
2. `useEffect`が実行されて`isClient`が`true`になる
3. localStorageからプロジェクト選択を読み込み
4. 必要に応じてプロジェクト選択画面をスキップ

## 修正ファイル

### 更新
1. `app/page.tsx`: SSR/CSRの一貫性を保つための修正

## 期待される効果

### 1. Hydrationエラーの解決
- サーバーサイドとクライアントサイドで同じ初期HTML
- Reactのハイドレーションが正常に完了

### 2. 機能の保持
- プロジェクト選択の永続化機能は維持
- ユーザビリティの向上も保持

### 3. パフォーマンスの向上
- ハイドレーションエラーによる再レンダリングの回避
- スムーズな初期表示

## 結果
✅ Hydrationエラーを解決しました
✅ SSR/CSRの一貫性を保つように修正しました
✅ プロジェクト選択の永続化機能を維持しました
✅ クライアントサイドでのみlocalStorageを読み込むように改善しました

これで、Hydrationエラーが解決され、プロジェクト選択の永続化機能も正常に動作するはずです！
